name: CFBlog Workflow with Conditional File Update and Clean Finish

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  update_search_xml:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Check for Existing File
      id: check_file
      run: |
        if [ -f "Data/search.xml" ]; then
          echo "::set-output name=exists::true"
        else
          echo "::set-output name=exists::false"
        fi

    - name: Fetch Remote Search XML
      env:
        CFBLOG_TOKEN: ${{ secrets.CFBLOG_TOKEN }}
        CFBLOG_HOST: ${{ secrets.CFBLOG_HOST }}
      run: |
        mkdir -p Data
        curl -s "https://${CFBLOG_HOST}/admin/search.xml" -H "cfblog_token: ${CFBLOG_TOKEN}" > Data/search_new.xml

    - name: Compare and Update if Different
      if: steps.check_file.outputs.exists == 'true'
      run: |
        cmp --silent Data/search.xml Data/search_new.xml || (
          echo "Files differ. Updating..."
          mv Data/search_new.xml Data/search.xml
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add Data/search.xml
          git commit -m "Update search.xml with changes"
          git push origin HEAD:$GITHUB_REF
        )

    - name: Commit and Push if File Didn't Exist
      if: steps.check_file.outputs.exists == 'false'
      run: |
        git config --global user.email "action@github.com"
        git.config --global user.name "GitHub Action"
        git add Data/
        git commit -m "Initial commit or re-adding search.xml"
        git push origin HEAD:$GITHUB_REF

    # 新增明确的完成步骤，确保工作流在无更新操作时也有正常结束的标志
    - name: Workflow Completion Marker
      if: always()
      run: echo 'Workflow finished. No changes made or all updates applied successfully.'
